---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import { TableOfContents } from '@/components/TableOfContents';
import { Calendar, Clock, ArrowLeft, User, Tag, Share2, Twitter, Linkedin } from 'lucide-react';
import { formatDate } from '@/lib/utils';
import Callout from '@/components/mdx/Callout.astro';
import Mermaid from '@/components/mdx/Mermaid.astro';
import { PostCard } from '@/components/PostCard';

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	return posts.map((post) => ({
		params: { slug: post.slug },
		props: post,
	}));
}

const post = Astro.props;
const { Content, headings } = await post.render();

// Calculate reading time
const wordCount = post.body.split(/\s+/).length;
const readingTime = Math.ceil(wordCount / 200);

// Map headings for TOC
const tocItems = headings.map(h => ({
	id: h.slug,
	text: h.text,
	level: h.depth
}));

// Fetch related posts
const allPosts = await getCollection('blog', ({ data, slug }) => {
    const isPublished = import.meta.env.PROD ? data.published !== false : true;
    return isPublished && slug !== post.slug;
});

const relatedPosts = allPosts
    .map(p => {
        const commonTags = p.data.tags?.filter(tag => post.data.tags?.includes(tag)) || [];
        return { post: p, score: commonTags.length };
    })
    .filter(p => p.score > 0)
    .sort((a, b) => b.score - a.score || b.post.data.date.getTime() - a.post.data.date.getTime())
    .slice(0, 3)
    .map(p => ({
        ...p.post.data,
        slug: p.post.slug,
        date: p.post.data.date.toISOString(), // PostCard expects string date
    }));

const shareUrl = new URL(Astro.url.pathname, Astro.site || 'https://porfolio-truongdq.vercel.app').toString();
const shareTitle = post.data.title;
---

<BaseLayout 
	title={post.data.title} 
	description={post.data.description}
	image={`/og/${post.slug}.png`}
	article={true}
	publishDate={post.data.date}
	tags={post.data.tags}
>
	<div class="min-h-screen">
		{/* Progress Bar (Optional, could be added later) */}

		<div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 py-12 pt-24">
			{/* Back Link */}
			<div class="mb-8">
				<a
					href="/blog"
					class="inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-primary transition-colors duration-200 group"
				>
					<ArrowLeft class="h-4 w-4 transition-transform duration-200 group-hover:-translate-x-1" />
					Back to Blog
				</a>
			</div>

			<div class="lg:grid lg:grid-cols-12 lg:gap-12">
				{/* Main Content Column */}
				<main class="lg:col-span-8 min-w-0">
					{/* Post Header */}
					<header class="mb-12 border-b border-border/40 pb-12">
						{/* Tags */}
						{post.data.tags && post.data.tags.length > 0 && (
							<div class="flex flex-wrap gap-2 mb-6">
								{post.data.tags.map((tag: string) => (
									<span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-primary/10 text-primary border border-primary/20">
										{tag}
									</span>
								))}
							</div>
						)}

						<h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold tracking-tight mb-6 text-foreground text-deep-shadow leading-tight">
							{post.data.title}
						</h1>

						{post.data.description && (
							<p class="text-xl text-muted-foreground mb-8 leading-relaxed">
								{post.data.description}
							</p>
						)}

						<div class="flex flex-wrap items-center gap-6 text-sm text-muted-foreground">
							{post.data.author && (
								<div class="flex items-center gap-2">
									<div class="h-8 w-8 rounded-full bg-gradient-to-tr from-primary/20 to-secondary/20 flex items-center justify-center ring-1 ring-border">
										<User class="h-4 w-4 text-primary" />
									</div>
									<span class="font-medium text-foreground">{post.data.author}</span>
								</div>
							)}
							<div class="flex items-center gap-2">
								<Calendar class="h-4 w-4" />
								<time datetime={post.data.date.toISOString()}>
									{formatDate(post.data.date)}
								</time>
							</div>
							<div class="flex items-center gap-2">
								<Clock class="h-4 w-4" />
								<span>{readingTime} min read</span>
							</div>
						</div>
					</header>

					{/* Article Content */}
					<article class="prose prose-lg dark:prose-invert max-w-none prose-headings:scroll-mt-24 prose-img:rounded-xl prose-img:shadow-lg">
						<Content components={{ Callout, Mermaid }} />
					</article>

					{/* Post Footer */}
					<footer class="mt-16 pt-8 border-t border-border">
						<div class="flex flex-col sm:flex-row items-center justify-between gap-6">
							<a
								href="/blog"
								class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-secondary/50 hover:bg-secondary text-secondary-foreground text-sm font-medium transition-all"
							>
								<ArrowLeft class="h-4 w-4" />
								View all articles
							</a>
							
							<div class="flex items-center gap-4">
								<span class="text-sm font-medium text-muted-foreground flex items-center gap-2">
									<Share2 class="h-4 w-4" />
									Share:
								</span>
								<div class="flex gap-2">
									<a
										href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareTitle)}`}
										target="_blank"
										rel="noopener noreferrer"
										class="p-2 rounded-full bg-secondary/50 hover:bg-primary/10 hover:text-primary transition-all duration-200"
										aria-label="Share on Twitter"
									>
										<Twitter class="h-4 w-4" />
									</a>
									<a
										href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(shareUrl)}`}
										target="_blank"
										rel="noopener noreferrer"
										class="p-2 rounded-full bg-secondary/50 hover:bg-primary/10 hover:text-primary transition-all duration-200"
										aria-label="Share on LinkedIn"
									>
										<Linkedin class="h-4 w-4" />
									</a>
								</div>
							</div>
						</div>
					</footer>

					{/* Related Posts Section */}
					{relatedPosts.length > 0 && (
						<section class="mt-24">
							<h2 class="text-2xl font-bold mb-8 flex items-center gap-3">
								<span class="h-8 w-1 bg-primary rounded-full"></span>
								Related Articles
							</h2>
							<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
								{relatedPosts.map(p => <PostCard post={p} />)}
							</div>
						</section>
					)}
				</main>

				{/* Sidebar (Table of Contents) */}
				<aside class="hidden lg:block lg:col-span-4 pl-8">
					<div class="sticky top-24 space-y-8">
						{/* Table of Contents Card */}
						{tocItems.length > 0 && (
							<div class="rounded-xl border border-border/40 bg-card/30 backdrop-blur-sm p-6 shadow-sm">
								<h3 class="font-semibold text-foreground mb-4 flex items-center gap-2">
									<span class="h-1.5 w-1.5 rounded-full bg-primary"></span>
									On this page
								</h3>
								<div class="toc-scroll-container max-h-[calc(100vh-200px)] overflow-y-auto pr-2 custom-scrollbar">
									<TableOfContents client:load items={tocItems} />
								</div>
							</div>
						)}
						
						{/* Related/newsletter placeholder could go here */}
					</div>
				</aside>
			</div>
		</div>
	</div>
</BaseLayout>

<style>
	.custom-scrollbar::-webkit-scrollbar {
		width: 4px;
	}
	.custom-scrollbar::-webkit-scrollbar-track {
		background: transparent;
	}
	.custom-scrollbar::-webkit-scrollbar-thumb {
		background: hsl(var(--muted));
		border-radius: 4px;
	}
	.custom-scrollbar::-webkit-scrollbar-thumb:hover {
		background: hsl(var(--muted-foreground));
	}
</style>
